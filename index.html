<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technospace Engineers - Tool and Machine Breakdown Management</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Brownish Theme Customization */
        :root {
            --primary-brown: #5D4037;
            --light-brown: #D7CCC8;
            --accent-gold: #FFB300;
        }
        body { background-color: #f5f5dc; } /* Beige background */
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #5D4037;
            border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Priority Selection Styles */
        .priority-box {
            transition: all 0.2s;
            cursor: pointer;
            opacity: 0.5;
            transform: scale(0.95);
        }
        .priority-box:hover { opacity: 0.8; }
        .priority-box.selected {
            opacity: 1;
            transform: scale(1.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
            border: 2px solid #5D4037;
        }
        
        /* Login Modal */
        .login-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        /* Report Table Styles */
        .report-table th {
            background-color: #5D4037;
            color: white;
        }
        .report-table tr:hover {
            background-color: #f9f9f9;
        }
    </style>
</head>
<body class="text-stone-800 font-sans min-h-screen flex flex-col">

    <!-- Login Modal -->
    <div id="loginModal" class="login-modal hidden">
        <div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-[#5D4037] mb-6">Login Required</h2>
            <p class="text-stone-600 mb-6">Please login to resolve tool breakdowns</p>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold mb-1">Username</label>
                    <input type="text" id="loginUsername" class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037]">
                </div>
                
                <div>
                    <label class="block text-sm font-bold mb-1">Password</label>
                    <input type="password" id="loginPassword" class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037]">
                </div>
                
                <div id="loginError" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded"></div>
                
                <div class="flex gap-2 pt-2">
                    <button onclick="attemptLogin()" class="flex-grow bg-[#5D4037] hover:bg-[#3E2723] text-white font-bold py-2 rounded transition">
                        Login
                    </button>
                    <button onclick="toggleLoginModal(false)" class="bg-stone-300 hover:bg-stone-400 text-stone-800 font-bold py-2 px-4 rounded transition">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <header class="bg-[#5D4037] text-white p-6 shadow-lg">
        <div class="container mx-auto flex flex-col md:flex-row items-center md:justify-between gap-4">            
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-bold tracking-wide">TECHNOSPACE ENGINEERS</h1>
                <p class="text-stone-300 text-sm">
                    Tool and Machine Breakdown Management System
                </p>
            </div>
            <div class="flex flex-col w-full md:w-auto md:flex-row items-center gap-3">
                <span id="userDisplay" class="text-sm hidden">
                    Logged in as: <span id="currentUser" class="font-bold"></span>
                    <button onclick="logout()" class="ml-2 text-xs underline">Logout</button>
                </span>
                <button onclick="toggleSection('resolve')" class="w-full md:w-auto bg-[#2F6B4F] hover:bg-[#245441] text-white px-4 py-2 rounded shadow transition">
                    Resolve Tool Issues
                </button>
                <button onclick="generateReport()" class="w-full md:w-auto bg-[#355C7D] hover:bg-[#2B4A63] text-white px-4 py-2 rounded shadow transition">
                    Generate Report
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow relative">

        <section id="reportSection" class="max-w-3xl mx-auto bg-white p-8 rounded-lg shadow-xl border-t-4 border-[#5D4037]">
            <h2 class="text-2xl font-bold text-[#5D4037] mb-6 border-b pb-2">Report New Breakdown</h2>
            
            <form id="breakdownForm" class="space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Tool Number/Machine Number <span class="text-red-500">*</span></label>
                        <input type="text" id="toolNumber" required placeholder="e.g. TT1738/P-50A" 
                            class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                    </div>
                    
                    <!-- NEW FIELD ADDED HERE -->
                    <div>
                        <label class="block text-sm font-bold mb-1">TS Code</label>
                        <input type="text" id="tsPartNumber" placeholder="e.g. 400" 
                            class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50" pattern="[0-9]{3,4}" maxlength="4">
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Type of Tool/Machine</label>
                        <select id="toolType" class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                            <option value="Blanking">Blanking</option>
                            <option value="Piercing">Piercing</option>
                            <option value="Bending">Bending</option>
                            <option value="Compound">Compound</option>
                            <option value="Progressive">Progressive</option>
                            <option value="Drawing">Drawing</option>
                            <option value="Forming">Forming</option>
                            <option value="Welding">Welding</option>
                            <option value="Machine">Machine</option>
                            <option value="Instrument">Instrument</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>

                <div class="bg-stone-50 p-3 rounded border border-stone-200">
                    <label class="block text-sm font-bold mb-2">Priority Level <span class="text-red-500">*</span></label>
                    <div class="flex gap-6 justify-start items-center">
                        <input type="hidden" id="priorityValue" required>
                        
                        <div onclick="selectPriority('Urgent')" id="prio-Urgent" class="priority-box bg-red-600 w-24 h-10 rounded flex items-center justify-center text-white font-bold text-xs shadow-sm">
                            URGENT
                        </div>
                        <div onclick="selectPriority('Medium')" id="prio-Medium" class="priority-box bg-yellow-500 w-24 h-10 rounded flex items-center justify-center text-white font-bold text-xs shadow-sm">
                            MEDIUM
                        </div>
                        <!-- <div onclick="selectPriority('Low')" id="prio-Low" class="priority-box bg-green-600 w-24 h-10 rounded flex items-center justify-center text-white font-bold text-xs shadow-sm">
                            LOW
                        </div> -->
                    </div>
                    <p id="prioError" class="text-red-500 text-xs mt-1 hidden">Please select a priority.</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Failure Mode (Category) <span class="text-red-500"></span></label>
                        <select id="failureReason" class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                            <option value="">Select Category (Optional)</option>
                            <option value="Punch Broken/Chipoff">Punch Broken/Chipoff</option>
                            <option value="Die Broken/Chipoff">Die Broken/Chipoff</option>
                            <option value="Scratches on Component">Scratches on Component</option>
                            <option value="Part Dimension not OK">Part Dimension not OK</option>
                            <option value="Burrs">Burrs</option>
                            <option value="Hole undersize">Hole undersize</option>
                            <option value="Improper Die Setting">Improper Die Setting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Issue Description / Details <span class="text-red-500">*</span></label>
                        <input type="text" id="breakdownDetail" required placeholder="Describe specific location/issue..." 
                            class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-bold mb-1">Breakdown Date/Time</label>
                        <input type="datetime-local" id="breakdownTime" required 
                            class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Reported By</label>
                        <input type="text" id="reportedBy" required placeholder="Name" 
                            class="w-full border border-stone-300 p-2 rounded focus:outline-none focus:border-[#5D4037] bg-stone-50">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold mb-1">Attach Photo</label>
                    <input type="file" id="breakdownPhoto" accept="image/*" 
                        class="w-full text-sm text-stone-500 file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-[#5D4037] file:text-white hover:file:bg-[#3E2723]">
                </div>

                <div class="pt-4">
                    <button type="submit" id="submitBtn" class="w-full bg-[#6D4C41] hover:bg-[#5D4037] text-white font-bold py-3 rounded transition flex justify-center items-center gap-2">
                        <span>Register Breakdown</span>
                        <div class="loader" id="submitLoader"></div>
                    </button>
                </div>
            </form>
        </section>

        <section id="resolveSection" class="hidden max-w-4xl mx-auto bg-stone-100 p-8 rounded-lg shadow-xl border-t-4 border-green-700">
            <div class="flex justify-between mb-6 border-b border-stone-300 pb-2">
                <h2 class="text-2xl font-bold text-green-800">Resolve Tool Issue</h2>
                <button onclick="toggleSection('report')" class="text-sm underline text-stone-600">Back to Report</button>
            </div>

            <div class="bg-white p-4 rounded mb-6 shadow-sm">
                <label class="block text-sm font-bold mb-2">Filter Complaints</label>
                <div class="flex gap-2">
                    <input type="text" id="searchQuery" placeholder="Search Tool No or Serial..." class="flex-grow border border-stone-300 p-2 rounded uppercase">
                    <button onclick="searchBreakdown()" class="bg-stone-600 text-white px-4 py-2 rounded hover:bg-stone-700">Search / Refresh</button>
                </div>
            </div>

            <div id="searchResults" class="space-y-4 grid grid-cols-1 gap-4"></div>
            
            <div id="paginationContainer" class="hidden text-center mt-6">
                <div class="flex justify-center items-center gap-4">
                    <button onclick="loadPreviousPage()" id="prevBtn" class="bg-stone-400 hover:bg-stone-500 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        ‚Üê Previous
                    </button>
                    <span id="pageInfo" class="text-stone-600 text-sm"></span>
                    <button onclick="loadNextPage()" id="nextBtn" class="bg-stone-400 hover:bg-stone-500 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50 disabled:cursor-not-allowed">
                        Next ‚Üí
                    </button>
                </div>
            </div>

            <div id="resolutionFormContainer" class="hidden mt-8 bg-white p-6 rounded shadow-lg border border-green-200">
                <h3 class="font-bold text-lg mb-4 text-[#5D4037] border-b pb-2">Closing Ticket #<span id="resSerialDisplay"></span></h3>
                <input type="hidden" id="resSerialId">
                
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-bold mb-1">Resolved By</label>
                            <input type="text" id="resolvedBy" required class="w-full border border-stone-300 p-2 rounded bg-stone-50">
                        </div>
                        <div>
                            <label class="block text-sm font-bold mb-1">Completion Date/Time</label>
                            <input type="datetime-local" id="resolutionTime" required class="w-full border border-stone-300 p-2 rounded bg-stone-50">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Maintenance Remarks / Action Taken</label>
                        <textarea id="maintenanceRemarks" rows="3" placeholder="Describe what was done to fix the tool..." class="w-full border border-stone-300 p-2 rounded bg-stone-50"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-bold mb-1">Attach Resolution Photo (Optional)</label>
                        <input type="file" id="resolutionPhoto" accept="image/*" class="w-full text-sm">
                    </div>
                    <button onclick="submitResolution()" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 rounded shadow">Close Ticket & Mark Resolved</button>
                </div>
            </div>
        </section>

        <!-- Report Generation Section -->
        <section id="reportGenerationSection" class="hidden max-w-6xl mx-auto bg-white p-8 rounded-lg shadow-xl border-t-4 border-blue-700">
            <div class="flex justify-between mb-6 border-b border-stone-300 pb-2">
                <h2 class="text-2xl font-bold text-blue-800">Generate Resolved Issues Report</h2>
                <div class="flex gap-2">
                    <button onclick="downloadPDF()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded shadow text-sm">
                        Download PDF Report
                    </button>
                    <button onclick="toggleSection('report')" class="text-sm underline text-stone-600">Back to Report</button>
                </div>
            </div>

            <div class="mb-6 space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-blue-50 p-4 rounded-lg">
                    <div>
                        <label class="block text-sm font-bold mb-1">From Date</label>
                        <input type="date" id="reportFromDate" class="w-full border border-stone-300 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">To Date</label>
                        <input type="date" id="reportToDate" class="w-full border border-stone-300 p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-sm font-bold mb-1">Tool Number</label>
                        <input type="text" id="reportToolNumber" placeholder="Filter by Tool No" class="w-full border border-stone-300 p-2 rounded uppercase">
                    </div>
                    <div class="flex items-end">
                        <button onclick="loadReportData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded">
                            Load Data
                        </button>
                    </div>
                </div>
                
                <div class="text-sm text-stone-600 flex justify-between">
                    <div id="reportStats" class="font-bold"></div>
                    <div id="reportGeneratedTime"></div>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table id="reportTable" class="w-full border-collapse border border-stone-300">
                    <thead class="bg-stone-100">
                        <tr>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Serial No</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Tool No</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">TS Part</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Tool Type</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Failure Reason</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Issue Description</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Reported By</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Breakdown Time</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Resolved By</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Resolution Time</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Duration (mins)</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Maintenance Remarks</th>
                            <th class="border border-stone-300 p-2 text-left text-xs font-bold">Photos</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody" class="text-sm">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>
            
            <div id="reportPagination" class="hidden text-center mt-6">
                <div class="flex justify-center items-center gap-4">
                    <button onclick="prevReportPage()" id="reportPrevBtn" class="bg-stone-400 hover:bg-stone-500 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50">
                        ‚Üê Previous
                    </button>
                    <span id="reportPageInfo" class="text-stone-600 text-sm"></span>
                    <button onclick="nextReportPage()" id="reportNextBtn" class="bg-stone-400 hover:bg-stone-500 text-white font-bold py-2 px-4 rounded shadow disabled:opacity-50">
                        Next ‚Üí
                    </button>
                </div>
            </div>
            
            <div id="noReportData" class="text-center text-stone-500 italic p-8 hidden">
                No resolved issues found for the selected criteria.
            </div>
        </section>

    </main>

    <footer class="text-center p-4 text-stone-500 text-sm">
        &copy; 2026 Technospace Engineers. Internal Use Only.
    </footer>

    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://eamwmyzcgjggadzfodpq.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhbXdteXpjZ2pnZ2FkemZvZHBxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc5NjA0MDIsImV4cCI6MjA4MzUzNjQwMn0.iZj26WVmNWvRPEpOT5Yxi1Ox-YP2H0nry5_xwFNWf5g";
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwLn8mx6Wx-S0kScz2oidoG6efC6WWADOtawklLzDlP7b7bshGcGiZjEGJYshbXp-Gx/exec";

        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- GLOBAL VARIABLES FOR DATA HANDLING ---
        let currentBreakdownData = [];
        let currentPage = 0;
        const PAGE_SIZE = 20;
        let totalRecords = 0;
        let isLoggedIn = false;
        let currentUsername = '';

        // --- Report generation variables ---
        let currentReportData = [];
        let currentReportPage = 0;
        const REPORT_PAGE_SIZE = 50;

        // --- HELPER FUNCTION: Get local datetime string ---
        function getLocalDateTimeString(date = new Date()) {
            // Format: YYYY-MM-DDTHH:MM (local time)
            const pad = (n) => n.toString().padStart(2, '0');
            const year = date.getFullYear();
            const month = pad(date.getMonth() + 1);
            const day = pad(date.getDate());
            const hours = pad(date.getHours());
            const minutes = pad(date.getMinutes());
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // --- HELPER FUNCTION: Format datetime for display (local time) ---
        function formatLocalDateTime(datetimeString) {
            if (!datetimeString) return 'N/A';
            return datetimeString
                .replace('T', ' ')
                .replace(/(\+00:00|Z)$/, '');
        }



        // --- NAVIGATION ---
        function toggleSection(view) {
            document.getElementById('reportSection').classList.add('hidden');
            document.getElementById('resolveSection').classList.add('hidden');
            document.getElementById('reportGenerationSection').classList.add('hidden');
            
            if(view === 'resolve') {
                // Check login before showing resolve section
                if (!isLoggedIn) {
                    toggleLoginModal(true);
                    return;
                }
                document.getElementById('resolveSection').classList.remove('hidden');
                document.getElementById('searchQuery').value = ""; 
                searchBreakdown(); 
            } else if (view === 'report') {
                document.getElementById('reportSection').classList.remove('hidden');
            } else if (view === 'generateReport') {
                generateReport();
            }
        }

        // --- LOGIN SYSTEM ---
        function toggleLoginModal(show) {
            document.getElementById('loginModal').classList.toggle('hidden', !show);
            if (show) {
                document.getElementById('loginError').classList.add('hidden');
                document.getElementById('loginUsername').focus();
            }
        }

        async function attemptLogin() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            const errorDiv = document.getElementById('loginError');

            if (!username || !password) {
                errorDiv.textContent = "Please enter both username and password";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Check credentials against database
            const { data, error } = await supabaseClient
                .from('users')
                .select('username')
                .eq('username', username)
                .eq('password', password)
                .single();

            if (error || !data) {
                errorDiv.textContent = "Invalid username or password";
                errorDiv.classList.remove('hidden');
                return;
            }

            // Login successful
            isLoggedIn = true;
            currentUsername = username;
            document.getElementById('currentUser').textContent = username;
            document.getElementById('userDisplay').classList.remove('hidden');
            document.getElementById('resolvedBy').value = username;
            
            toggleLoginModal(false);
            
            // Auto-switch to resolve section
            toggleSection('resolve');
        }

        function logout() {
            isLoggedIn = false;
            currentUsername = '';
            document.getElementById('userDisplay').classList.add('hidden');
            toggleSection('report');
        }

        // --- PRIORITY UI LOGIC ---
        function selectPriority(level) {
            document.getElementById('priorityValue').value = level;
            ['Urgent', 'Medium'].forEach(l => {
                document.getElementById('prio-'+l).classList.remove('selected');
            });
            document.getElementById('prio-'+level).classList.add('selected');
            document.getElementById('prioError').classList.add('hidden');
        }


        // --- UPLOAD HELPER ---
        async function uploadImage(fileInputId) {
            const fileInput = document.getElementById(fileInputId);
            if (fileInput.files.length === 0) return null;
            const file = fileInput.files[0];
            const reader = new FileReader();
            return new Promise((resolve, reject) => {
                reader.onload = async function() {
                    const base64 = reader.result.split(',')[1];
                    try {
                        const response = await fetch(GOOGLE_SCRIPT_URL, {
                            method: "POST",
                            body: JSON.stringify({ file: base64, filename: file.name, mimeType: file.type })
                        });
                        const data = await response.json();
                        resolve(data.result === "success" ? data.url : null);
                    } catch (err) { console.error(err); resolve(null); }
                };
                reader.readAsDataURL(file);
            });
        }

        // --- SUBMIT REPORT (WITH DUPLICATE CHECK) ---
        document.getElementById('breakdownForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const priority = document.getElementById('priorityValue').value;
            if(!priority) {
                document.getElementById('prioError').classList.remove('hidden');
                return;
            }

            const btn = document.getElementById('submitBtn');
            const loader = document.getElementById('submitLoader');
            const toolNumber = document.getElementById('toolNumber').value.toUpperCase().trim();
            const tsPartNumber = document.getElementById('tsPartNumber').value;
            
            btn.disabled = true;
            loader.style.display = 'inline-block';

            // 1. Check for duplicate pending breakdown
            const { data: existingData, error: checkError } = await supabaseClient
                .from('tool_breakdowns')
                .select('serial_number')
                .eq('tool_number', toolNumber)
                .eq('status', 'Pending');

            if (existingData && existingData.length > 0) {
                // Show confirmation dialog
                const shouldContinue = confirm(
                    "‚ö†Ô∏è WARNING: A pending breakdown already exists for this tool or machine.\n\n" +
                    "Do you want to continue and register this new breakdown anyway?\n\n" +
                    "Click OK to continue, Cancel to stop."
                );
                
                if (!shouldContinue) {
                    btn.disabled = false;
                    loader.style.display = 'none';
                    return;
                }
            }

            // 2. Continue with submission
            let photoUrl = await uploadImage('breakdownPhoto');

            // Get the local datetime value from input (already in local time)
            const breakdownTimeLocal = document.getElementById('breakdownTime').value;

            const { data, error } = await supabaseClient
                .from('tool_breakdowns')
                .insert([{
                    tool_number: toolNumber,
                    ts_part_number: tsPartNumber || null,
                    tool_type: document.getElementById('toolType').value,
                    failure_reason: document.getElementById('failureReason').value || null,
                    breakdown_type: document.getElementById('breakdownDetail').value,
                    breakdown_time: breakdownTimeLocal, // Store as local time string
                    reported_by: document.getElementById('reportedBy').value,
                    breakdown_photo_url: photoUrl,
                    priority: priority,
                    status: 'Pending'
                }])
                .select();

            if (error) {
                alert('Error: ' + error.message);
            } else {
                alert('Breakdown Registered! Serial No: ' + data[0].serial_number);
                document.getElementById('breakdownForm').reset();
                // Reset Priority UI
                ['Urgent', 'Medium'].forEach(l => {
                    document.getElementById('prio-'+l).classList.remove('selected');
                });
                document.getElementById('priorityValue').value = "";
                document.getElementById('tsPartNumber').value = "";
                // Reset breakdown time to current local time
                document.getElementById('breakdownTime').value = getLocalDateTimeString();
            }

            btn.disabled = false;
            loader.style.display = 'none';
        });

        // --- SEARCH & PAGINATION LOGIC ---
        async function searchBreakdown() {
            const query = document.getElementById('searchQuery').value.toUpperCase().trim();
            const resultsDiv = document.getElementById('searchResults');
            const paginationDiv = document.getElementById('paginationContainer');
            
            resultsDiv.innerHTML = '<p class="text-stone-500 text-center py-4">Loading complaints...</p>';
            paginationDiv.classList.add('hidden');
            document.getElementById('resolutionFormContainer').classList.add('hidden');

            currentPage = 0;
            await loadBreakdownPage(0, query);
        }

        async function loadBreakdownPage(page, query = '') {
            const resultsDiv = document.getElementById('searchResults');
            const paginationDiv = document.getElementById('paginationContainer');
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            const start = page * PAGE_SIZE;
            const end = start + PAGE_SIZE - 1;

            // Build query with server-side sorting
            let dbQuery = supabaseClient
                .from('tool_breakdowns')
                .select('serial_number, tool_number, tool_type, failure_reason, breakdown_type, breakdown_time, reported_by, breakdown_photo_url, priority', { count: 'exact' })
                .eq('status', 'Pending')
                .order('priority_numeric', { ascending: false }) // Database sorting
                .order('breakdown_time', { ascending: false })
                .range(start, end);

            if (query !== '') {
                if (!isNaN(query)) {
                    dbQuery = dbQuery.eq('serial_number', query);
                } else {
                    dbQuery = dbQuery.eq('tool_number', query);
                }
            }

            const { data, error, count } = await dbQuery;

            if (error) {
                resultsDiv.innerHTML = '<p class="text-red-500 text-center">Error loading data.</p>';
                return;
            }

            if (!data || data.length === 0) {
                resultsDiv.innerHTML = '<p class="text-center text-stone-500 italic p-4">No pending breakdowns found.</p>';
                paginationDiv.classList.add('hidden');
                return;
            }

            totalRecords = count;
            currentBreakdownData = data;
            currentPage = page;

            // Render the page
            renderBreakdownPage();

            // Update pagination controls
            pageInfo.textContent = `Page ${page + 1} (${start + 1}-${Math.min(end + 1, totalRecords)} of ${totalRecords})`;
            prevBtn.disabled = page === 0;
            nextBtn.disabled = end + 1 >= totalRecords;
            paginationDiv.classList.remove('hidden');
        }

        function renderBreakdownPage() {
            const resultsDiv = document.getElementById('searchResults');
            
            let html = '';
            currentBreakdownData.forEach(item => {
                // Priority Visuals
                let borderClass = 'border-l-4 ';
                let bgBadge = '';
                
                if(item.priority === 'Urgent') {
                    borderClass += 'border-red-600';
                    bgBadge = '<span class="bg-red-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">URGENT</span>';
                } else if(item.priority === 'Medium') {
                    borderClass += 'border-yellow-500';
                    bgBadge = '<span class="bg-yellow-500 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">MEDIUM</span>';
                } else {
                    borderClass += 'border-green-600';
                    bgBadge = '<span class="bg-green-600 text-white text-[10px] font-bold px-2 py-0.5 rounded uppercase">LOW</span>';
                }

                // Image Link Logic
                let imageLink = '';
                if(item.breakdown_photo_url && item.breakdown_photo_url.length > 5) {
                    imageLink = `
                        <a href="${item.breakdown_photo_url}" target="_blank" class="mt-2 inline-block text-blue-600 hover:text-blue-800 text-sm font-bold">
                            üìÑ View Photo on Drive
                        </a>
                    `;
                } else {
                    imageLink = `<span class="mt-2 text-xs text-stone-400 block italic">No photo attached</span>`;
                }

                html += `
                    <div class="${borderClass} p-4 rounded bg-white shadow flex flex-col md:flex-row justify-between items-start gap-4 transition hover:shadow-md">
                        <div class="flex-grow">
                            <div class="flex justify-between items-center mb-1">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-lg text-[#5D4037]}">${item.tool_number}</span>
                                    ${bgBadge}
                                </div>
                                <span class="text-xs bg-stone-200 px-2 py-1 rounded text-stone-600">#${item.serial_number}</span>
                            </div>
                            <p class="text-sm font-semibold text-stone-700">Type: ${item.tool_type}</p>
                            
                            <div class="mt-2">
                                <span class="bg-stone-100 border border-stone-300 px-2 py-0.5 text-xs font-bold rounded text-stone-600 uppercase">
                                    ${item.failure_reason || 'Unknown'}
                                </span>
                                <p class="text-red-700 font-medium mt-1">"${item.breakdown_type}"</p>
                            </div>

                            <p class="text-xs text-stone-500 mt-2">Reported by ${item.reported_by} <br> ${formatLocalDateTime(item.breakdown_time)}</p>
                            ${imageLink}
                        </div>
                        <div class="self-center md:self-start">
                             <button onclick="selectForResolution(${item.serial_number})" class="bg-stone-700 hover:bg-stone-800 text-white px-6 py-2 rounded shadow transition text-sm">
                                Resolve
                             </button>
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }

        function loadNextPage() {
            const query = document.getElementById('searchQuery').value.toUpperCase().trim();
            loadBreakdownPage(currentPage + 1, query);
        }

        function loadPreviousPage() {
            const query = document.getElementById('searchQuery').value.toUpperCase().trim();
            loadBreakdownPage(currentPage - 1, query);
        }

        // --- SELECT RESOLUTION ---
        async function selectForResolution(serialNumber) {
            // Verify login
            if (!isLoggedIn) {
                toggleLoginModal(true);
                return;
            }

            // Fetch the breakdown details
            const { data, error } = await supabaseClient
                .from('tool_breakdowns')
                .select('breakdown_time')
                .eq('serial_number', serialNumber)
                .single();

            if (error) {
                alert("Error loading breakdown details");
                return;
            }

            document.getElementById('resSerialDisplay').innerText = serialNumber;
            document.getElementById('resSerialId').value = serialNumber;
            document.getElementById('resolutionFormContainer').classList.remove('hidden');
            document.getElementById('resolutionTime').value = getLocalDateTimeString();
            
            // Store breakdown time for resolution duration calculation
            document.getElementById('resolutionFormContainer').dataset.breakdownTime = data.breakdown_time;
            
            document.getElementById('resolutionFormContainer').scrollIntoView({behavior: 'smooth'});
        }

        // --- SUBMIT RESOLUTION ---
        async function submitResolution() {
            if (!isLoggedIn) {
                toggleLoginModal(true);
                return;
            }

            const serialId = document.getElementById('resSerialId').value;
            const resolvedBy = document.getElementById('resolvedBy').value;
            const resTime = document.getElementById('resolutionTime').value;
            const remarks = document.getElementById('maintenanceRemarks').value;

            if(!resTime) {
                alert("Please enter completion time");
                return;
            }

            // Calculate resolution duration in minutes using local times
            const breakdownTime = document.getElementById('resolutionFormContainer').dataset.breakdownTime;
            function parseLocalDateTime(str) {
                const [datePart, timePart] = str.split('T');
                const [y, m, d] = datePart.split('-').map(Number);
                const [hh, mm] = timePart.split(':').map(Number);
                return new Date(y, m - 1, d, hh, mm);
            }

            const startTime = parseLocalDateTime(breakdownTime);
            const endTime = parseLocalDateTime(resTime);
            const totalMinutes = Math.round((endTime - startTime) / (1000 * 60));
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;

            const durationMinutes = totalMinutes;
            const durationFormatted = hours > 0 
                ? `${hours} hr ${minutes} min`
                : `${minutes} min`;

            let photoUrl = await uploadImage('resolutionPhoto');

            const { error } = await supabaseClient
                .from('tool_breakdowns')
                .update({
                    status: 'Resolved',
                    resolved_by: resolvedBy,
                    resolution_time: resTime, // Store as local time string
                    maintenance_remarks: remarks,
                    resolution_photo_url: photoUrl,
                    resolution_duration_minutes: durationMinutes
                })
                .eq('serial_number', serialId);

            if(error) {
                alert("Error updating: " + error.message);
            } else {
                alert(`Issue marked as Resolved!\nResolution time: ${durationFormatted}`);
                toggleSection('resolve');
            }
        }

        // --- REPORT GENERATION FUNCTIONS ---
        function generateReport() {
            document.getElementById('reportSection').classList.add('hidden');
            document.getElementById('resolveSection').classList.add('hidden');
            document.getElementById('reportGenerationSection').classList.remove('hidden');
            
            // Set default dates (last 30 days) in local time
            const today = new Date();
            const lastMonth = new Date();
            lastMonth.setDate(today.getDate() - 30);
            
            document.getElementById('reportFromDate').value = lastMonth.toISOString().split('T')[0];
            document.getElementById('reportToDate').value = today.toISOString().split('T')[0];
            
            loadReportData();
        }

        async function loadReportData(page = 0) {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const toolNumber = document.getElementById('reportToolNumber').value.toUpperCase().trim();
            
            if (!fromDate || !toDate) {
                alert('Please select both from and to dates');
                return;
            }
            
            const start = page * REPORT_PAGE_SIZE;
            const end = start + REPORT_PAGE_SIZE - 1;
            
            let query = supabaseClient
                .from('tool_breakdowns')
                .select('*', { count: 'exact' })
                .eq('status', 'Resolved')
                .gte('breakdown_time', fromDate + 'T00:00:00')
                .lte('breakdown_time', toDate + 'T23:59:59')
                .order('breakdown_time', { ascending: false })
                .range(start, end);
            
            if (toolNumber) {
                query = query.ilike('tool_number', `%${toolNumber}%`);
            }
            
            const { data, error, count } = await query;
            
            if (error) {
                console.error('Error loading report data:', error);
                alert('Error loading report data');
                return;
            }
            
            currentReportData = data || [];
            currentReportPage = page;
            
            if (currentReportData.length === 0) {
                document.getElementById('reportTable').classList.add('hidden');
                document.getElementById('noReportData').classList.remove('hidden');
                document.getElementById('reportPagination').classList.add('hidden');
                document.getElementById('reportStats').textContent = 'No records found';
            } else {
                document.getElementById('reportTable').classList.remove('hidden');
                document.getElementById('noReportData').classList.add('hidden');
                renderReportTable();
                
                // Update stats
                const totalCount = count || currentReportData.length;
                document.getElementById('reportStats').textContent = 
                    `Showing ${start + 1}-${Math.min(end + 1, totalCount)} of ${totalCount} resolved issues`;
                
                // Update pagination
                const totalPages = Math.ceil(totalCount / REPORT_PAGE_SIZE);
                document.getElementById('reportPageInfo').textContent = 
                    `Page ${page + 1} of ${totalPages}`;
                
                document.getElementById('reportPrevBtn').disabled = page === 0;
                document.getElementById('reportNextBtn').disabled = end + 1 >= totalCount;
                document.getElementById('reportPagination').classList.remove('hidden');
            }
            
            // Update generated time
            document.getElementById('reportGeneratedTime').textContent = 
                `Generated on: ${new Date().toLocaleString()}`;
        }

        function renderReportTable() {
            const tbody = document.getElementById('reportTableBody');
            let html = '';
            
            currentReportData.forEach(item => {
                const breakdownTime = formatLocalDateTime(item.breakdown_time);
                const resolutionTime = formatLocalDateTime(item.resolution_time);
                let duration = 'N/A';

                if (item.resolution_duration_minutes !== null) {
                    const totalMinutes = Math.abs(item.resolution_duration_minutes);
                    const h = Math.floor(totalMinutes / 60);
                    const m = totalMinutes % 60;
                    duration = h > 0 ? `${h} hr ${m} min` : `${m} min`;
                }
                
                // Photo links
                let photoLinks = '';
                if (item.breakdown_photo_url) {
                    photoLinks += `<a href="${item.breakdown_photo_url}" target="_blank" class="block text-xs text-blue-600 hover:text-blue-800">üì∑ Issue Photo</a>`;
                }
                if (item.resolution_photo_url) {
                    photoLinks += `<a href="${item.resolution_photo_url}" target="_blank" class="block text-xs text-green-600 hover:text-green-800 mt-1">‚úÖ Resolution Photo</a>`;
                }
                if (!photoLinks) {
                    photoLinks = '<span class="text-xs text-stone-400">No photos</span>';
                }
                
                html += `
                    <tr class="hover:bg-stone-50 border-b">
                        <td class="p-2 border border-stone-200 text-xs">${item.serial_number}</td>
                        <td class="p-2 border border-stone-200 font-bold">${item.tool_number}</td>
                        <td class="p-2 border border-stone-200">${item.ts_part_number || '-'}</td>
                        <td class="p-2 border border-stone-200">${item.tool_type}</td>
                        <td class="p-2 border border-stone-200">${item.failure_reason || '-'}</td>
                        <td class="p-2 border border-stone-200">${item.breakdown_type}</td>
                        <td class="p-2 border border-stone-200">${item.reported_by}</td>
                        <td class="p-2 border border-stone-200 text-xs">${breakdownTime}</td>
                        <td class="p-2 border border-stone-200">${item.resolved_by || '-'}</td>
                        <td class="p-2 border border-stone-200 text-xs">${resolutionTime}</td>
                        <td class="p-2 border border-stone-200 text-center font-bold ${item.resolution_duration_minutes > 120 
                            ? 'text-red-600' 
                            : item.resolution_duration_minutes > 60 
                                ? 'text-yellow-600' 
                                : 'text-green-600'}
                        ">
                            ${duration}
                        </td>
                        <td class="p-2 border border-stone-200 text-xs max-w-xs">${item.maintenance_remarks || '-'}</td>
                        <td class="p-2 border border-stone-200">${photoLinks}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function nextReportPage() {
            loadReportData(currentReportPage + 1);
        }

        function prevReportPage() {
            loadReportData(currentReportPage - 1);
        }

        async function downloadPDF() {
            const fromDate = document.getElementById('reportFromDate').value;
            const toDate = document.getElementById('reportToDate').value;
            const toolNumber = document.getElementById('reportToolNumber').value;
            
            // Fetch all data for PDF (not just current page)
            let query = supabaseClient
                .from('tool_breakdowns')
                .select('*')
                .eq('status', 'Resolved')
                .gte('breakdown_time', fromDate + 'T00:00:00')
                .lte('breakdown_time', toDate + 'T23:59:59')
                .order('breakdown_time', { ascending: false });
            
            if (toolNumber) {
                query = query.ilike('tool_number', `%${toolNumber}%`);
            }
            
            const { data, error } = await query;
            
            if (error || !data || data.length === 0) {
                alert('No data available for PDF generation');
                return;
            }
            
            if (typeof window.jspdf === 'undefined') {
                alert('PDF library not loaded. Please wait and try again.');
                return;
            }
            
            generatePDF(data, fromDate, toDate);
        }

        function generatePDF(data, fromDate, toDate) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('landscape');
            
            // Title
            doc.setFontSize(18);
            doc.text('Technospace Engineers - Resolved Issues Report', 14, 15);
            doc.setFontSize(11);
            doc.text(`Period: ${fromDate} to ${toDate}`, 14, 22);
            doc.text(`Generated on: ${new Date().toLocaleString()}`, 14, 28);
            doc.text(`Total Issues: ${data.length}`, 14, 34);
            
            // Prepare table data
            const tableData = data.map(item => [
                item.serial_number,
                item.tool_number,
                item.ts_part_number || '-',
                item.tool_type,
                item.failure_reason || '-',
                item.breakdown_type.substring(0, 30) + (item.breakdown_type.length > 30 ? '...' : ''),
                item.reported_by,
                item.breakdown_time.split('T')[0], // Date only
                item.resolved_by || '-',
                item.resolution_time.split('T')[0], // Date only
                (() => {
                    if (item.resolution_duration_minutes === null) return 'N/A';
                    const t = Math.abs(item.resolution_duration_minutes);
                    const h = Math.floor(t / 60);
                    const m = t % 60;
                    return h > 0 ? `${h} hr ${m} min` : `${m} min`;
                })(),
                item.maintenance_remarks ? (item.maintenance_remarks.substring(0, 40) + (item.maintenance_remarks.length > 40 ? '...' : '')) : '-'
            ]);
            
            // Add table
            doc.autoTable({
                head: [
                    ['Serial', 'Tool No', 'TS Part', 'Type', 'Failure Reason', 'Issue', 'Reported By', 'Breakdown Date', 'Resolved By', 'Resolution Date', 'Duration(mins)', 'Remarks']
                ],
                body: tableData,
                startY: 40,
                theme: 'grid',
                styles: { fontSize: 8 },
                headStyles: { fillColor: [93, 64, 55] }, // Brown color
                columnStyles: {
                    0: { cellWidth: 15 },
                    1: { cellWidth: 20 },
                    2: { cellWidth: 15 },
                    3: { cellWidth: 20 },
                    4: { cellWidth: 25 },
                    5: { cellWidth: 30 },
                    6: { cellWidth: 20 },
                    7: { cellWidth: 20 },
                    8: { cellWidth: 20 },
                    9: { cellWidth: 20 },
                    10: { cellWidth: 15 },
                    11: { cellWidth: 40 }
                }
            });
            
            // Save PDF
            const filename = `Technospace_Report_${fromDate}_to_${toDate}.pdf`;
            doc.save(filename);
        }

        // Initialize with current local time
        document.getElementById('breakdownTime').value = getLocalDateTimeString();
    </script>
</body>
</html>